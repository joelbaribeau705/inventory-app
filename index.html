<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Tracker with Admin Controls</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Barcode/QR Code scanning library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <!-- QR Code Generation Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <!-- CSV Parsing Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        #reader video { width: 100% !important; height: auto !important; border-radius: 0.5rem; }
        .modal-enter { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @media print {
            body * { visibility: hidden; }
            #qr-code-print-area, #qr-code-print-area * { visibility: visible; }
            #qr-code-print-area { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%; 
                height: 100%; 
                display: flex; 
                flex-direction: column; 
                justify-content: center; 
                align-items: center;
                background-color: white !important;
                color: black !important;
            }
            #details-qr-code {
                padding: 0 !important;
            }
            #details-qr-code img {
                width: 150px !important;
                height: 150px !important;
            }
            .print-info {
                color: black !important;
                text-align: center;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <!-- Auth Screen (Login/Register) -->
    <div id="auth-screen" class="min-h-screen flex items-center justify-center">
        <div class="w-full max-w-md p-8 space-y-8 bg-gray-800 rounded-xl shadow-lg border border-gray-700">
            <div class="text-center">
                 <svg viewBox="0 0 300 70" class="h-12 w-auto mx-auto mb-4" xmlns="http://www.w3.org/2000/svg">
                    <style>.logo-font { font-family: 'Inter', sans-serif; font-style: italic; font-weight: 700; }</style>
                    <text x="0" y="55" class="logo-font" style="font-size: 48px;" fill="#E53E3E">Mi</text>
                    <text x="75" y="35" class="logo-font" style="font-size: 28px;" fill="#F3F4F6">REPAIR &</text>
                    <text x="75" y="65" class="logo-font" style="font-size: 28px;" fill="#F3F4F6">SERVICES</text>
                </svg>
                <h2 id="auth-title" class="mt-6 text-center text-3xl font-extrabold text-white">Sign in to your account</h2>
                <p id="auth-subtitle" class="mt-2 text-center text-sm text-gray-400">
                    Or <a href="#" id="toggle-auth-mode" class="font-medium text-red-500 hover:text-red-400">request access</a>
                </p>
            </div>
            <form id="auth-form" class="mt-8 space-y-6">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <label for="email-address" class="sr-only">Email address</label>
                        <input id="email-address" name="email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-t-md focus:outline-none focus:ring-red-500 focus:border-red-500 focus:z-10 sm:text-sm" placeholder="Email address">
                    </div>
                    <div>
                        <label for="password" class="sr-only">Password</label>
                        <input id="password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-b-md focus:outline-none focus:ring-red-500 focus:border-red-500 focus:z-10 sm:text-sm" placeholder="Password">
                    </div>
                </div>
                <div id="auth-error" class="text-red-400 text-sm h-4"></div>
                <div>
                    <button type="submit" id="auth-button" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                        Sign In
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Pending Approval Screen -->
    <div id="pending-approval-screen" class="hidden min-h-screen flex items-center justify-center">
        <div class="text-center">
            <h2 class="text-2xl font-semibold text-white">Account Pending Approval</h2>
            <p class="text-gray-400 mt-2">Your account has been created and is awaiting approval from an administrator.</p>
        </div>
    </div>


    <!-- Main App Screen -->
    <div id="app-screen" class="hidden">
        <div class="container mx-auto p-4 max-w-7xl">
            <header class="text-center my-6 relative">
                <svg viewBox="0 0 300 70" class="h-16 w-auto mx-auto mb-4" xmlns="http://www.w3.org/2000/svg">
                  <style>.logo-font { font-family: 'Inter', sans-serif; font-style: italic; font-weight: 700; }</style>
                  <text x="0" y="55" class="logo-font" style="font-size: 48px;" fill="#E53E3E">Mi</text>
                  <text x="75" y="35" class="logo-font" style="font-size: 28px;" fill="#F3F4F6">REPAIR &</text>
                  <text x="75" y="65" class="logo-font" style="font-size: 28px;" fill="#F3F4F6">SERVICES</text>
                </svg>
                <h1 class="text-4xl font-bold text-white">Inventory Tracker</h1>
                <div class="absolute top-0 right-0 flex space-x-4">
                    <button id="scan-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">Scan & Adjust</button>
                    <button id="manage-users-btn" class="hidden relative bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                        Manage Users
                        <span id="pending-users-badge" class="absolute -top-2 -right-2 bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded-full hidden">0</span>
                    </button>
                    <button id="logout-btn" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-500 transition-colors">Log Out</button>
                </div>
                <p class="text-gray-400 mt-2">Shared inventory with QR code scanning and generation.</p>
            </header>

            <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                <div class="flex justify-between items-center mb-2 flex-wrap gap-4">
                    <h2 class="text-2xl font-semibold text-white">Current Stock</h2>
                    <div class="flex space-x-2">
                       <button id="import-csv-btn" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors">Import CSV</button>
                       <button id="export-csv-btn" class="bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700 transition-colors">Export CSV</button>
                       <button id="add-item-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">+ Add New Part</button>
                    </div>
                </div>
                <div id="total-value-display" class="text-lg text-gray-300 mb-4 text-right pr-2">Total Inventory Value: $0.00</div>
                <!-- Search Bar -->
                <div class="mb-4">
                    <input type="text" id="search-bar" class="w-full px-4 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="Search by Part Number or Description...">
                </div>
                <!-- Tabs for Inventory View -->
                <div class="border-b border-gray-700 mb-4">
                    <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                        <button id="tab-all" class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-red-500 text-white">
                            All Items
                        </button>
                        <button id="tab-reorder" class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-white hover:border-gray-300">
                            Re-Order Needed
                            <span id="reorder-count-badge" class="ml-2 bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded-full hidden">0</span>
                        </button>
                    </nav>
                </div>
                <div id="inventory-list" class="space-y-3 max-h-[50vh] overflow-y-auto pr-2"></div>
            </div>
            
            <!-- Purchase Orders Section -->
            <div class="mt-8 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                 <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                    <h2 class="text-2xl font-semibold text-white">Purchase Orders</h2>
                    <button id="add-po-btn" class="bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-700 transition-colors">+ New PO</button>
                </div>
                <!-- Tabs for PO View -->
                <div class="border-b border-gray-700 mb-4">
                    <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                        <button id="po-tab-open" class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-cyan-500 text-white">
                            Open POs
                        </button>
                        <button id="po-tab-completed" class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-white hover:border-gray-300">
                            Completed POs
                        </button>
                    </nav>
                </div>
                <div id="po-list" class="space-y-3 max-h-[50vh] overflow-y-auto pr-2"></div>
            </div>

            <div id="user-info" class="text-center mt-6 text-xs text-gray-500"></div>
        </div>
    </div>

    <!-- Add/Edit Item Modal -->
    <div id="add-item-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="bg-gray-800 rounded-xl shadow-2xl p-8 w-full max-w-lg modal-enter border border-gray-700 max-h-[90vh] overflow-y-auto">
            <h3 id="modal-title" class="text-2xl font-bold mb-6 text-white">Add New Inventory Part</h3>
            <form id="add-item-form" class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
                <div class="sm:col-span-2"><label for="partNumber" class="block text-sm font-medium text-gray-300 mb-1">Part Number (Unique ID)</label><input type="text" id="partNumber" name="partNumber" class="w-full px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg focus:ring-red-500 focus:border-red-500" required></div>
                <div class="sm:col-span-2"><label for="partDescription" class="block text-sm font-medium text-gray-300 mb-1">Part Description</label><input type="text" id="partDescription" name="partDescription" class="w-full px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg focus:ring-red-500 focus:border-red-500" required></div>
                <div><label for="manufacturer" class="block text-sm font-medium text-gray-300 mb-1">Manufacturer</label><input type="text" id="manufacturer" name="manufacturer" class="w-full px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg focus:ring-red-500 focus:border-red-500"></div>
                <div><label for="binLocation" class="block text-sm font-medium text-gray-300 mb-1">Bin Location</label><input type="text" id="binLocation" name="binLocation" class="w-full px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg focus:ring-red-500 focus:border-red-500"></div>
                <div><label for="dateCode" class="block text-sm font-medium text-gray-300 mb-1">Date Code</label><input type="date" id="dateCode" name="dateCode" class="w-full px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg focus:ring-red-500 focus:border-red-500"></div>
                <div><label for="cost" class="block text-sm font-medium text-gray-300 mb-1">Cost (per unit)</label><input type="number" id="cost" name="cost" min="0" step="0.01" value="0" class="w-full px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg focus:ring-red-500 focus:border-red-500"></div>
                <div><label for="quantity" class="block text-sm font-medium text-gray-300 mb-1">Current Quantity</label><input type="number" id="quantity" name="quantity" min="0" value="0" class="w-full px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg focus:ring-red-500 focus:border-red-500" required></div>
                <div><label for="minQuantity" class="block text-sm font-medium text-gray-300 mb-1">Min Stock Level</label><input type="number" id="minQuantity" name="minQuantity" min="0" value="0" class="w-full px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg focus:ring-red-500 focus:border-red-500"></div>
                <div class="sm:col-span-2"><label for="maxQuantity" class="block text-sm font-medium text-gray-300 mb-1">Max Stock Level</label><input type="number" id="maxQuantity" name="maxQuantity" min="0" value="0" class="w-full px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg focus:ring-red-500 focus:border-red-500"></div>
                <div class="sm:col-span-2 flex justify-between space-x-4 mt-4">
                    <button type="button" id="delete-item-btn" class="bg-red-800 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition-colors">Delete</button>
                    <div>
                        <button type="button" id="cancel-modal-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-500 transition-colors">Cancel</button>
                        <button type="submit" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition-colors ml-2">Save Part</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Item Details & QR Code Modal -->
    <div id="details-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="bg-gray-800 rounded-xl shadow-2xl p-8 w-full max-w-md modal-enter border border-gray-700">
             <div id="qr-code-print-area" class="bg-gray-800 text-center">
                 <h3 id="details-title" class="text-2xl font-bold mb-2 text-white print-info">Part Details</h3>
                 <p id="details-part-number" class="text-gray-400 mb-2 print-info"></p>
                 <p id="details-part-description" class="text-gray-300 mb-2 print-info"></p>
                 <p id="details-bin-location" class="text-gray-300 mb-2 print-info"></p>
                 <p id="details-date-code" class="text-gray-300 mb-4 print-info"></p>
                 <div id="details-qr-code" class="bg-white p-4 rounded-lg w-64 h-64 mx-auto"></div>
             </div>
             <div class="text-center mt-6">
                 <button id="print-qr-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">Print QR Code</button>
                 <button id="close-details-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-500 transition-colors ml-4">Close</button>
             </div>
        </div>
    </div>

    <!-- Adjust Stock Modal -->
    <div id="adjust-stock-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="bg-gray-800 rounded-xl shadow-2xl p-8 w-full max-w-md modal-enter border border-gray-700">
            <h3 class="text-2xl font-bold mb-2 text-white">Adjust Stock</h3>
            <p id="adjust-stock-part-info" class="text-gray-400 mb-4"></p>
            <div class="text-center mb-4">
                <p class="text-lg text-gray-400">Current Quantity</p>
                <p id="adjust-stock-current-qty" class="text-5xl font-bold text-white">0</p>
            </div>
            <div class="flex items-center justify-center space-x-4 mb-4">
                <button id="adjust-stock-down-btn" class="bg-red-600 text-white font-bold rounded-full w-12 h-12 text-3xl flex items-center justify-center">-</button>
                <button id="adjust-stock-up-btn" class="bg-green-600 text-white font-bold rounded-full w-12 h-12 text-3xl flex items-center justify-center">+</button>
            </div>
            <div class="flex items-center space-x-2">
                <input type="number" id="adjust-stock-amount" class="w-full px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="Set specific quantity...">
                <button id="adjust-stock-set-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Set</button>
            </div>
             <div class="text-right mt-6">
                <button id="close-adjust-stock-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-500">Done</button>
            </div>
        </div>
    </div>

    <!-- Manage Users Modal -->
    <div id="manage-users-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="bg-gray-800 rounded-xl shadow-2xl p-8 w-full max-w-3xl modal-enter border border-gray-700">
            <h3 class="text-2xl font-bold mb-6 text-white">Manage Users</h3>
            <!-- User Management Tabs -->
            <div class="border-b border-gray-700 mb-4">
                <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                    <button id="user-tab-active" class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-red-500 text-white">
                        Active Users
                    </button>
                    <button id="user-tab-pending" class="relative whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-white hover:border-gray-300">
                        Pending Requests
                        <span id="pending-requests-badge" class="ml-2 absolute top-2 -right-6 bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded-full hidden">0</span>
                    </button>
                </nav>
            </div>
            <div id="users-list-container" class="space-y-3 max-h-[60vh] overflow-y-auto"></div>
            <div class="text-right mt-6">
                <button id="close-users-modal-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-500">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Import CSV Modal -->
    <div id="import-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="bg-gray-800 rounded-xl shadow-2xl p-8 w-full max-w-lg modal-enter border border-gray-700">
            <h3 class="text-2xl font-bold mb-4 text-white">Import from CSV</h3>
            <p class="text-gray-400 mb-4">Upload a CSV file with your inventory data. The system will use the 'partNumber' to add new items or update existing ones.</p>
            <div class="mb-4">
                <button id="download-template-btn" class="text-sm text-purple-400 hover:text-purple-300">Download CSV Template</button>
            </div>
            <div class="mb-4">
                <label for="csv-file-input" class="block text-sm font-medium text-gray-300 mb-1">CSV File</label>
                <input type="file" id="csv-file-input" accept=".csv" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-600 file:text-white hover:file:bg-purple-700"/>
            </div>
            <div id="import-status" class="mt-4 text-sm"></div>
            <div class="flex justify-end space-x-4 mt-6">
                <button type="button" id="cancel-import-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-500">Cancel</button>
                <button type="button" id="process-import-btn" class="bg-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-purple-700">Upload & Process</button>
            </div>
        </div>
    </div>

    <!-- Add PO Modal -->
    <div id="add-po-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="bg-gray-800 rounded-xl shadow-2xl p-8 w-full max-w-lg modal-enter border border-gray-700">
            <h3 id="po-modal-title" class="text-2xl font-bold mb-6 text-white">Create Purchase Order</h3>
            <form id="add-po-form">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div><label for="po-number" class="block text-sm font-medium text-gray-300 mb-1">PO Number</label><input type="text" id="po-number" required class="w-full px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg"></div>
                    <div><label for="po-date" class="block text-sm font-medium text-gray-300 mb-1">PO Date</label><input type="date" id="po-date" required class="w-full px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg"></div>
                    <div class="sm:col-span-2"><label for="po-vendor" class="block text-sm font-medium text-gray-300 mb-1">Vendor</label><input type="text" id="po-vendor" required class="w-full px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg"></div>
                    <div><label for="po-part-number" class="block text-sm font-medium text-gray-300 mb-1">Part Number</label><input type="text" id="po-part-number" required class="w-full px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg"></div>
                    <div><label for="po-quantity" class="block text-sm font-medium text-gray-300 mb-1">Quantity</label><input type="number" id="po-quantity" min="1" value="1" required class="w-full px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg"></div>
                    <div><label for="po-cost" class="block text-sm font-medium text-gray-300 mb-1">Cost (per unit)</label><input type="number" id="po-cost" min="0" step="0.01" value="0" required class="w-full px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg"></div>
                    <div><label for="po-delivery-date" class="block text-sm font-medium text-gray-300 mb-1">Expected Delivery</label><input type="date" id="po-delivery-date" required class="w-full px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg"></div>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="cancel-po-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-500">Cancel</button>
                    <button type="submit" class="bg-cyan-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-cyan-700">Save PO</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Scanner Modal -->
    <div id="scanner-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="bg-gray-800 rounded-xl shadow-2xl p-8 w-full max-w-lg modal-enter border border-gray-700">
            <h3 class="text-2xl font-bold mb-4 text-white">Scan QR Code</h3>
            <div id="scanner-reader" class="w-full aspect-video bg-gray-700 rounded-lg mb-4 overflow-hidden"></div>
            <div id="scanner-status" class="mt-4 text-sm text-center"></div>
            <div class="text-right mt-6">
                <button type="button" id="close-scanner-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-500">Close</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="bg-gray-800 rounded-xl shadow-2xl p-8 w-full max-w-md modal-enter border border-gray-700">
            <h3 id="confirm-title" class="text-2xl font-bold mb-4 text-white">Confirm Action</h3>
            <p id="confirm-message" class="text-gray-300 mb-6"></p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-confirm-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-500">Cancel</button>
                <button id="confirm-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Notification Area -->
    <div id="notification-area" class="fixed bottom-4 right-4 z-50 space-y-2"></div>


    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, where, serverTimestamp, increment, getDocs, deleteDoc, runTransaction, writeBatch, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global State ---
        let db, auth, appId, currentUser = null;
        let html5QrCode;
        let isScannerRunning = false;
        let inventoryCollectionRef, usersCollectionRef, poCollectionRef;
        let inventoryDocs = [];
        let poDocs = [];
        let currentView = 'all';
        let currentPoView = 'Open';
        let currentUserManagementView = 'active';
        let isLoginMode = true;
        let currentAdjustingPartId = null;
        let currentEditingPoId = null;
        let currentEditingItemId = null;
        let confirmAction = null;

        // --- DOM Element References ---
        const loadingScreen = document.getElementById('loading-screen');
        const appScreen = document.getElementById('app-screen');
        const authScreen = document.getElementById('auth-screen');
        const pendingApprovalScreen = document.getElementById('pending-approval-screen');
        const authForm = document.getElementById('auth-form');
        const authError = document.getElementById('auth-error');
        const toggleAuthModeLink = document.getElementById('toggle-auth-mode');
        const authTitle = document.getElementById('auth-title');
        const authSubtitle = document.getElementById('auth-subtitle');
        const authButton = document.getElementById('auth-button');
        const logoutBtn = document.getElementById('logout-btn');
        const manageUsersBtn = document.getElementById('manage-users-btn');
        const manageUsersModal = document.getElementById('manage-users-modal');
        const closeUsersModalBtn = document.getElementById('close-users-modal-btn');
        const usersListContainer = document.getElementById('users-list-container');
        const startScanBtn = document.getElementById('scan-btn');
        const inventoryListEl = document.getElementById('inventory-list');
        const addItemBtn = document.getElementById('add-item-btn');
        const addItemModal = document.getElementById('add-item-modal');
        const cancelModalBtn = document.getElementById('cancel-modal-btn');
        const addItemForm = document.getElementById('add-item-form');
        const partNumberInput = document.getElementById('partNumber');
        const userInfoEl = document.getElementById('user-info');
        const detailsModal = document.getElementById('details-modal');
        const closeDetailsBtn = document.getElementById('close-details-btn');
        const printQrBtn = document.getElementById('print-qr-btn');
        const detailsQrCodeEl = document.getElementById('details-qr-code');
        const detailsPartNumberEl = document.getElementById('details-part-number');
        const detailsPartDescriptionEl = document.getElementById('details-part-description');
        const detailsBinLocationEl = document.getElementById('details-bin-location');
        const detailsDateCodeEl = document.getElementById('details-date-code');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const importCsvBtn = document.getElementById('import-csv-btn');
        const importModal = document.getElementById('import-modal');
        const cancelImportBtn = document.getElementById('cancel-import-btn');
        const processImportBtn = document.getElementById('process-import-btn');
        const csvFileInput = document.getElementById('csv-file-input');
        const downloadTemplateBtn = document.getElementById('download-template-btn');
        const importStatus = document.getElementById('import-status');
        const tabAll = document.getElementById('tab-all');
        const tabReorder = document.getElementById('tab-reorder');
        const reorderCountBadge = document.getElementById('reorder-count-badge');
        const totalValueDisplay = document.getElementById('total-value-display');
        const pendingUsersBadge = document.getElementById('pending-users-badge');
        const userTabActive = document.getElementById('user-tab-active');
        const userTabPending = document.getElementById('user-tab-pending');
        const pendingRequestsBadge = document.getElementById('pending-requests-badge');
        const searchBar = document.getElementById('search-bar');
        const adjustStockModal = document.getElementById('adjust-stock-modal');
        const adjustStockPartInfo = document.getElementById('adjust-stock-part-info');
        const adjustStockCurrentQty = document.getElementById('adjust-stock-current-qty');
        const adjustStockUpBtn = document.getElementById('adjust-stock-up-btn');
        const adjustStockDownBtn = document.getElementById('adjust-stock-down-btn');
        const adjustStockAmount = document.getElementById('adjust-stock-amount');
        const adjustStockSetBtn = document.getElementById('adjust-stock-set-btn');
        const closeAdjustStockBtn = document.getElementById('close-adjust-stock-btn');
        const addPoBtn = document.getElementById('add-po-btn');
        const addPoModal = document.getElementById('add-po-modal');
        const cancelPoBtn = document.getElementById('cancel-po-btn');
        const addPoForm = document.getElementById('add-po-form');
        const poListEl = document.getElementById('po-list');
        const poModalTitle = document.getElementById('po-modal-title');
        const deleteItemBtn = document.getElementById('delete-item-btn');
        const scannerModal = document.getElementById('scanner-modal');
        const closeScannerBtn = document.getElementById('close-scanner-btn');
        const scannerStatus = document.getElementById('scanner-status');
        const modalTitle = document.getElementById('modal-title');
        const poTabOpen = document.getElementById('po-tab-open');
        const poTabCompleted = document.getElementById('po-tab-completed');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const cancelConfirmBtn = document.getElementById('cancel-confirm-btn');
        const confirmBtn = document.getElementById('confirm-btn');


        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            setupFirebase();
            setupEventListeners();
            html5QrCode = new Html5Qrcode("scanner-reader");
        });
        
        async function setupFirebase() {
            try {
                const firebaseConfig = {
                  apiKey: "AIzaSyCrpnw-qBMAk7idkd6SRMmFNa0vRSKsNGM",
                  authDomain: "on42-inventory-app.firebaseapp.com",
                  projectId: "on42-inventory-app",
                  storageBucket: "on42-inventory-app.firebasestorage.app",
                  messagingSenderId: "852160968126",
                  appId: "1:852160968126:web:a0819d25ddaefeed86b5ef",
                  measurementId: "G-ZG3S421XYN"
                };

                appId = firebaseConfig.appId;
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                inventoryCollectionRef = collection(db, "inventory");
                usersCollectionRef = collection(db, "users");
                poCollectionRef = collection(db, "purchaseOrders");

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        try {
                            const userProfile = await getUserProfile(user.uid);
                            if (userProfile) {
                                currentUser = { uid: user.uid, email: user.email, ...userProfile };
                                if (currentUser.role === 'pending') {
                                    showPendingScreen();
                                } else {
                                    showApp();
                                }
                            } else {
                                showAuthScreen();
                            }
                        } catch (error) {
                            console.error("Error getting user profile:", error);
                            showAuthScreen();
                        }
                    } else {
                        currentUser = null;
                        showAuthScreen();
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                document.body.innerHTML = `<div class="text-center p-8 text-red-500">Error initializing the application. Please check the console.</div>`;
            }
        }

        function setupEventListeners() {
            authForm.addEventListener('submit', handleAuthFormSubmit);
            toggleAuthModeLink.addEventListener('click', toggleAuthMode);
            logoutBtn.addEventListener('click', handleLogout);
            manageUsersBtn.addEventListener('click', showUsersModal);
            closeUsersModalBtn.addEventListener('click', () => manageUsersModal.classList.add('hidden'));
            startScanBtn.addEventListener('click', toggleScanner);
            closeScannerBtn.addEventListener('click', toggleScanner);
            addItemBtn.addEventListener('click', () => showAddItemModal());
            cancelModalBtn.addEventListener('click', hideAddItemModal);
            addItemForm.addEventListener('submit', handleSaveItem);
            closeDetailsBtn.addEventListener('click', hideDetailsModal);
            printQrBtn.addEventListener('click', () => window.print());
            exportCsvBtn.addEventListener('click', handleExport);
            importCsvBtn.addEventListener('click', () => importModal.classList.remove('hidden'));
            cancelImportBtn.addEventListener('click', () => importModal.classList.add('hidden'));
            downloadTemplateBtn.addEventListener('click', handleDownloadTemplate);
            processImportBtn.addEventListener('click', handleProcessImport);
            tabAll.addEventListener('click', () => setView('all'));
            tabReorder.addEventListener('click', () => setView('reorder'));
            userTabActive.addEventListener('click', () => setUserManagementView('active'));
            userTabPending.addEventListener('click', () => setUserManagementView('pending'));
            searchBar.addEventListener('input', () => renderInventory(inventoryDocs));
            closeAdjustStockBtn.addEventListener('click', () => adjustStockModal.classList.add('hidden'));
            adjustStockUpBtn.addEventListener('click', () => adjustStock(1));
            adjustStockDownBtn.addEventListener('click', () => adjustStock(-1));
            adjustStockSetBtn.addEventListener('click', () => {
                const amount = parseInt(adjustStockAmount.value, 10);
                if (!isNaN(amount)) {
                    setStock(amount);
                }
            });
            addPoBtn.addEventListener('click', showAddPoModal);
            cancelPoBtn.addEventListener('click', () => addPoModal.classList.add('hidden'));
            addPoForm.addEventListener('submit', handleAddPo);
            deleteItemBtn.addEventListener('click', handleDeleteItem);
            poTabOpen.addEventListener('click', () => setPoView('Open'));
            poTabCompleted.addEventListener('click', () => setPoView('Completed'));
            cancelConfirmBtn.addEventListener('click', () => confirmModal.classList.add('hidden'));
            confirmBtn.addEventListener('click', () => {
                if (confirmAction) {
                    confirmAction();
                }
            });
        }

        // --- UI Control ---
        function showApp() {
            authScreen.classList.add('hidden');
            pendingApprovalScreen.classList.add('hidden');
            appScreen.classList.remove('hidden');
            userInfoEl.innerHTML = `<p>Signed in as: <strong class="select-all">${currentUser.email}</strong> (${currentUser.role})</p>`;
            
            if (currentUser.role === 'admin') {
                manageUsersBtn.classList.remove('hidden');
                setupUsersListener();
            } else {
                manageUsersBtn.classList.add('hidden');
            }
            setupInventoryListener();
            setupPoListener();
        }

        function showAuthScreen() {
            appScreen.classList.add('hidden');
            pendingApprovalScreen.classList.add('hidden');
            authScreen.classList.remove('hidden');
        }
        
        function showPendingScreen() {
            authScreen.classList.add('hidden');
            appScreen.classList.add('hidden');
            pendingApprovalScreen.classList.remove('hidden');
        }

        function toggleAuthMode(e) {
            if(e) e.preventDefault();
            isLoginMode = !isLoginMode;
            authError.textContent = '';
            if (isLoginMode) {
                authTitle.textContent = 'Sign in to your account';
                authSubtitle.innerHTML = 'Or <a href="#" id="toggle-auth-mode" class="font-medium text-red-500 hover:text-red-400">request access</a>';
                authButton.textContent = 'Sign In';
            } else {
                authTitle.textContent = 'Request Access';
                authSubtitle.innerHTML = 'Already have an account? <a href="#" id="toggle-auth-mode" class="font-medium text-red-500 hover:text-red-400">Sign in</a>';
                authButton.textContent = 'Create Account';
            }
            document.getElementById('toggle-auth-mode').addEventListener('click', toggleAuthMode);
        }

        function setView(view) {
            currentView = view;
            if (view === 'all') {
                tabAll.classList.add('border-red-500', 'text-white');
                tabAll.classList.remove('border-transparent', 'text-gray-400');
                tabReorder.classList.add('border-transparent', 'text-gray-400');
                tabReorder.classList.remove('border-red-500', 'text-white');
            } else { // 'reorder'
                tabReorder.classList.add('border-red-500', 'text-white');
                tabReorder.classList.remove('border-transparent', 'text-gray-400');
                tabAll.classList.add('border-transparent', 'text-gray-400');
                tabAll.classList.remove('border-red-500', 'text-white');
            }
            renderInventory(inventoryDocs);
        }
        
        function setPoView(view) {
            currentPoView = view;
            if (view === 'Open') {
                poTabOpen.classList.add('border-cyan-500', 'text-white');
                poTabOpen.classList.remove('border-transparent', 'text-gray-400');
                poTabCompleted.classList.add('border-transparent', 'text-gray-400');
                poTabCompleted.classList.remove('border-cyan-500', 'text-white');
            } else { // 'Completed'
                poTabCompleted.classList.add('border-cyan-500', 'text-white');
                poTabCompleted.classList.remove('border-transparent', 'text-gray-400');
                poTabOpen.classList.add('border-transparent', 'text-gray-400');
                poTabOpen.classList.remove('border-cyan-500', 'text-white');
            }
            renderPurchaseOrders(poDocs);
        }
        
        function setUserManagementView(view) {
            currentUserManagementView = view;
             if (view === 'active') {
                userTabActive.classList.add('border-red-500', 'text-white');
                userTabActive.classList.remove('border-transparent', 'text-gray-400');
                userTabPending.classList.add('border-transparent', 'text-gray-400');
                userTabPending.classList.remove('border-red-500', 'text-white');
            } else { // 'pending'
                userTabPending.classList.add('border-red-500', 'text-white');
                userTabPending.classList.remove('border-transparent', 'text-gray-400');
                userTabActive.classList.add('border-transparent', 'text-gray-400');
                userTabActive.classList.remove('border-red-500', 'text-white');
            }
            showUsersModal(); // Re-render the user list
        }

        // --- Authentication & User Profile Logic ---
        async function handleAuthFormSubmit(e) {
            e.preventDefault();
            const email = authForm.email.value;
            const password = authForm.password.value;
            authError.textContent = '';

            try {
                if (isLoginMode) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await setupNewUser(userCredential.user);
                    showPendingScreen();
                }
            } catch (error) {
                console.error("Auth Error:", error.code, error.message);
                authError.textContent = error.message;
            }
        }

        async function handleLogout() {
            await signOut(auth);
        }
        
        async function setupNewUser(user) {
            const adminConfigRef = doc(db, "system", "config");
            let role = 'pending';
            
            try {
                await runTransaction(db, async (transaction) => {
                    const configDoc = await transaction.get(adminConfigRef);
                    if (!configDoc.exists()) {
                        role = 'admin';
                        transaction.set(adminConfigRef, { adminAssigned: true });
                    }
                });
            } catch (e) {
                console.log("Admin check transaction failed (this is expected for non-first users).");
            }

            const userDocRef = doc(usersCollectionRef, user.uid);
            await setDoc(userDocRef, {
                uid: user.uid,
                email: user.email,
                role: role,
                createdAt: serverTimestamp()
            });
        }

        async function getUserProfile(uid) {
            const userDocRef = doc(usersCollectionRef, uid);
            const docSnap = await getDoc(userDocRef);
            return docSnap.exists() ? docSnap.data() : null;
        }

        // --- Admin User Management ---
        function setupUsersListener() {
            onSnapshot(query(usersCollectionRef), (snapshot) => {
                const pendingUsers = snapshot.docs.filter(doc => doc.data().role === 'pending').length;
                if (pendingUsers > 0) {
                    pendingUsersBadge.textContent = pendingUsers;
                    pendingUsersBadge.classList.remove('hidden');
                    pendingRequestsBadge.textContent = pendingUsers;
                    pendingRequestsBadge.classList.remove('hidden');
                } else {
                    pendingUsersBadge.classList.add('hidden');
                    pendingRequestsBadge.classList.add('hidden');
                }
            });
        }

        async function showUsersModal() {
            usersListContainer.innerHTML = '<p>Loading users...</p>';
            if (manageUsersModal.classList.contains('hidden')) {
                manageUsersModal.classList.remove('hidden');
            }
            
            const q = query(usersCollectionRef, where("role", "==", currentUserManagementView));
            const querySnapshot = await getDocs(q);
            usersListContainer.innerHTML = '';

            if (querySnapshot.empty) {
                usersListContainer.innerHTML = `<p class="text-gray-500 text-center py-8">No ${currentUserManagementView} users found.</p>`;
                return;
            }

            querySnapshot.forEach((doc) => {
                const user = doc.data();
                const userEl = document.createElement('div');
                userEl.className = 'p-3 border border-gray-700 rounded-lg flex justify-between items-center';
                
                let buttonsHtml = '';
                if (currentUserManagementView === 'pending') {
                    buttonsHtml = `
                        <div>
                            <button data-uid="${doc.id}" class="approve-user-btn bg-green-600 text-white font-bold py-1 px-3 rounded hover:bg-green-700 mr-2">Approve</button>
                            <button data-uid="${doc.id}" data-email="${user.email}" class="deny-user-btn bg-red-800 text-white font-bold py-1 px-3 rounded hover:bg-red-700">Deny</button>
                        </div>
                    `;
                } else if (currentUser.uid !== doc.id && user.role !== 'admin') {
                     buttonsHtml = `<button data-uid="${doc.id}" data-email="${user.email}" class="delete-user-btn bg-red-800 text-white font-bold py-1 px-3 rounded hover:bg-red-700">Delete</button>`;
                }

                userEl.innerHTML = `
                    <div>
                        <p class="font-semibold text-white">Email: ${user.email}</p>
                        <p class="text-sm text-gray-400">Role: ${user.role}</p>
                    </div>
                    ${buttonsHtml}
                `;
                usersListContainer.appendChild(userEl);
            });

            document.querySelectorAll('.delete-user-btn, .deny-user-btn').forEach(btn => btn.addEventListener('click', handleDeleteUser));
            document.querySelectorAll('.approve-user-btn').forEach(btn => btn.addEventListener('click', handleApproveUser));
        }

        async function handleApproveUser(e) {
            const uidToApprove = e.target.dataset.uid;
            const userDocRef = doc(usersCollectionRef, uidToApprove);
            try {
                await updateDoc(userDocRef, { role: 'user' });
                showScanMessage(`User approved.`, 'success');
                showUsersModal();
            } catch (error) {
                console.error("Error approving user:", error);
                showScanMessage('Failed to approve user.', 'error');
            }
        }

        async function handleDeleteUser(e) {
            const uidToDelete = e.target.dataset.uid;
            const emailToDelete = e.target.dataset.email;
            
            confirmAction = async () => {
                try {
                    await deleteDoc(doc(usersCollectionRef, uidToDelete));
                    showScanMessage(`User deleted.`, 'success');
                    showUsersModal();
                } catch (error) {
                    console.error("Error deleting user:", error);
                    showScanMessage('Failed to delete user.', 'error');
                }
                confirmModal.classList.add('hidden');
                confirmAction = null;
            };
            
            confirmTitle.textContent = "Confirm User Deletion";
            confirmMessage.textContent = `Are you sure you want to permanently delete the user ${emailToDelete}? This action cannot be undone.`;
            confirmModal.classList.remove('hidden');
        }

        // --- CSV Import/Export ---
        function handleDownloadTemplate() {
            const headers = "partNumber,partDescription,manufacturer,binLocation,cost,dateCode,quantity,minQuantity,maxQuantity";
            const blob = new Blob([headers], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "inventory_template.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function handleExport() {
            showScanMessage('Generating CSV export...', 'info');
            try {
                const querySnapshot = await getDocs(inventoryCollectionRef);
                let csvContent = "partNumber,partDescription,manufacturer,binLocation,cost,dateCode,quantity,minQuantity,maxQuantity,createdAt,lastUpdated\n";
                
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const row = [
                        doc.id,
                        `"${(data.partDescription || '').replace(/"/g, '""')}"`,
                        `"${(data.manufacturer || '').replace(/"/g, '""')}"`,
                        `"${(data.binLocation || '').replace(/"/g, '""')}"`,
                        data.cost || 0,
                        `"${(data.dateCode || '').replace(/"/g, '""')}"`,
                        data.quantity || 0,
                        data.minQuantity || 0,
                        data.maxQuantity || 0,
                        data.createdAt ? data.createdAt.toDate().toISOString() : '',
                        data.lastUpdated ? data.lastUpdated.toDate().toISOString() : ''
                    ].join(',');
                    csvContent += row + "\n";
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `inventory_export_${new Date().toISOString().slice(0,10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showScanMessage('Export successful!', 'success');
            } catch (error) {
                console.error("Error exporting CSV:", error);
                showScanMessage('Export failed. See console for details.', 'error');
            }
        }

        function handleProcessImport() {
            const file = csvFileInput.files[0];
            if (!file) {
                importStatus.textContent = "Please select a file first.";
                importStatus.className = "text-red-400";
                return;
            }

            processImportBtn.disabled = true;
            processImportBtn.textContent = "Processing...";
            importStatus.textContent = "Parsing file...";
            importStatus.className = "text-yellow-400";

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: async (results) => {
                    importStatus.textContent = `Found ${results.data.length} rows. Uploading to database...`;
                    const batch = writeBatch(db);
                    let processedCount = 0;

                    for (const row of results.data) {
                        const partNumber = row.partNumber;
                        if (!partNumber) continue;

                        const itemDocRef = doc(inventoryCollectionRef, partNumber.trim());
                        const itemData = {
                            partDescription: row.partDescription || '',
                            manufacturer: row.manufacturer || '',
                            binLocation: row.binLocation || '',
                            cost: parseFloat(row.cost) || 0,
                            dateCode: row.dateCode || '',
                            quantity: parseInt(row.quantity, 10) || 0,
                            minQuantity: parseInt(row.minQuantity, 10) || 0,
                            maxQuantity: parseInt(row.maxQuantity, 10) || 0,
                            lastUpdated: serverTimestamp(),
                        };
                        
                        batch.set(itemDocRef, itemData, { merge: true });
                        processedCount++;
                    }

                    try {
                        await batch.commit();
                        importStatus.textContent = `Successfully processed ${processedCount} items!`;
                        importStatus.className = "text-green-400";
                        setTimeout(() => {
                            importModal.classList.add('hidden');
                            processImportBtn.disabled = false;
                            processImportBtn.textContent = "Upload & Process";
                        }, 2000);
                    } catch (error) {
                        console.error("Error committing batch:", error);
                        importStatus.textContent = "Error uploading data. See console for details.";
                        importStatus.className = "text-red-400";
                        processImportBtn.disabled = false;
                        processImportBtn.textContent = "Upload & Process";
                    }
                },
                error: (error) => {
                    console.error("CSV Parsing Error:", error);
                    importStatus.textContent = "Failed to parse CSV file.";
                    importStatus.className = "text-red-400";
                    processImportBtn.disabled = false;
                    processImportBtn.textContent = "Upload & Process";
                }
            });
        }


        // --- Inventory Functions ---
        function setupInventoryListener() {
            onSnapshot(query(inventoryCollectionRef), (snapshot) => {
                inventoryDocs = snapshot.docs;
                
                let reorderCount = 0;
                let totalValue = 0;
                inventoryDocs.forEach(doc => {
                    const item = doc.data();
                    if (item.quantity <= item.minQuantity && item.minQuantity > 0) {
                        reorderCount++;
                    }
                    totalValue += (item.quantity || 0) * (item.cost || 0);
                });

                totalValueDisplay.textContent = `Total Inventory Value: $${totalValue.toFixed(2)}`;
                if (reorderCount > 0) {
                    reorderCountBadge.textContent = reorderCount;
                    reorderCountBadge.classList.remove('hidden');
                } else {
                    reorderCountBadge.classList.add('hidden');
                }
                
                renderInventory(inventoryDocs);
            }, (error) => {
                console.error("Firestore snapshot error:", error);
                 loadingScreen.innerHTML = `<div class="text-center text-red-400 p-4">
                    <h3 class="font-bold text-lg">Database Error</h3>
                    <p>Could not read from the database. This is often due to incorrect Firestore security rules.</p>
                    <p class="mt-2 text-sm text-gray-400">Please double-check your security rules in the Firebase Console.</p>
                </div>`;
                showAuthScreen();
            });
        }
        
        function renderInventory(docs) {
            const searchTerm = searchBar.value.toLowerCase();
            let docsToRender = docs.filter(doc => {
                const item = doc.data();
                const partNumber = doc.id.toLowerCase();
                const description = (item.partDescription || '').toLowerCase();
                return partNumber.includes(searchTerm) || description.includes(searchTerm);
            });

            if (currentView === 'reorder') {
                docsToRender = docsToRender.filter(doc => {
                    const item = doc.data();
                    return item.quantity <= item.minQuantity && item.minQuantity > 0;
                });
            }

            inventoryListEl.innerHTML = '';
            if (docsToRender.length === 0) {
                const message = currentView === 'reorder' 
                    ? "No items need to be re-ordered." 
                    : "No items in inventory. Add a part to begin.";
                inventoryListEl.innerHTML = `<p class="text-gray-500 text-center py-8">${message}</p>`;
                return;
            }

            const sortedDocs = docsToRender.sort((a, b) => a.data().partDescription.toLowerCase().localeCompare(b.data().partDescription.toLowerCase()));
            
            sortedDocs.forEach(doc => {
                const item = doc.data();
                let stockStatusClass = 'bg-green-500';
                if (item.quantity <= item.minQuantity && item.minQuantity > 0) stockStatusClass = 'bg-red-500 animate-pulse';
                else if (item.quantity > item.maxQuantity && item.maxQuantity > 0) stockStatusClass = 'bg-yellow-500';

                const itemEl = document.createElement('div');
                itemEl.className = 'p-4 border border-gray-700 rounded-lg grid grid-cols-5 gap-4 items-center';
                itemEl.innerHTML = `
                    <div class="col-span-3 cursor-pointer hover:bg-gray-700/50" data-part-id="${doc.id}">
                        <p class="font-semibold text-white">${item.partDescription}</p>
                        <p class="text-sm text-gray-400">P/N: ${doc.id}</p>
                        <p class="text-sm text-gray-500">${item.manufacturer || 'N/A'} | Bin: ${item.binLocation || 'N/A'} | Date: ${item.dateCode || 'N/A'}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-2xl font-bold text-red-500">${item.quantity}</p>
                        <p class="text-xs text-gray-500">In Stock</p>
                    </div>
                    <div class="flex justify-end items-center space-x-2">
                        ${currentUser.role === 'admin' ? `<button class="edit-item-btn p-2 rounded-md hover:bg-gray-600" data-part-id="${doc.id}">
                            <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path></svg>
                        </button>` : ''}
                        <button class="qr-code-btn p-2 rounded-md hover:bg-gray-600" data-part-id="${doc.id}">
                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h-1m-1-6v1m-5-4h1m-1 12h1m-6-11v1m-5 4h1m6 11v1M4 12H3m18 0h-1m-1-6h1M8 4v1m-4 7h1m11 6h1m-6-1V8a2 2 0 012-2h4a2 2 0 012 2v8a2 2 0 01-2 2h-4a2 2 0 01-2-2z"></path></svg>
                        </button>
                        <span class="w-4 h-4 rounded-full ${stockStatusClass}" title="Stock Status"></span>
                    </div>
                `;
                itemEl.querySelector('.col-span-3').addEventListener('click', (e) => showAdjustStockModal(e.currentTarget.dataset.partId));
                itemEl.querySelector('.qr-code-btn').addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    showDetailsModal(e.currentTarget.dataset.partId);
                });
                if (currentUser.role === 'admin') {
                    const editBtn = itemEl.querySelector('.edit-item-btn');
                    if(editBtn) {
                        editBtn.addEventListener('click', (e) => {
                            e.stopPropagation(); 
                            handleEditItem(e.currentTarget.dataset.partId);
                        });
                    }
                }
                inventoryListEl.appendChild(itemEl);
            });
        }

        async function toggleScanner() {
            if (isScannerRunning) {
                try { 
                    await html5QrCode.stop(); 
                    isScannerRunning = false; 
                    scannerModal.classList.add('hidden');
                } catch (err) { console.error("Error stopping scanner:", err); }
            } else {
                scannerModal.classList.remove('hidden');
                scannerStatus.textContent = 'Starting camera...';
                try {
                    await html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, handleScannedBarcode);
                    isScannerRunning = true;
                    scannerStatus.textContent = 'Ready to scan.';
                } catch (err) { 
                    scannerStatus.textContent = 'Error: Could not start camera.';
                    console.error(err);
                }
            }
        }

        async function handleScannedBarcode(decodedText) {
            await toggleScanner(); // Close the scanner modal
            showAdjustStockModal(decodedText);
        }
        
        async function handleSaveItem(e) {
            e.preventDefault();
            const partNumber = addItemForm.partNumber.value.trim();
            if (!partNumber) { showScanMessage('Part Number is required.', 'error'); return; }
            const itemData = {
                partDescription: addItemForm.partDescription.value.trim(),
                manufacturer: addItemForm.manufacturer.value.trim(),
                binLocation: addItemForm.binLocation.value.trim(),
                cost: parseFloat(addItemForm.cost.value) || 0,
                dateCode: addItemForm.dateCode.value.trim(),
                quantity: parseInt(addItemForm.quantity.value, 10) || 0,
                minQuantity: parseInt(addItemForm.minQuantity.value, 10) || 0,
                maxQuantity: parseInt(addItemForm.maxQuantity.value, 10) || 0,
                lastUpdated: serverTimestamp()
            };
            const itemDocRef = doc(inventoryCollectionRef, partNumber);
            try {
                if (currentEditingItemId) {
                     await setDoc(itemDocRef, itemData, { merge: true });
                     showScanMessage(`Part ${partNumber} updated!`, 'success');
                } else {
                    const docSnap = await getDoc(itemDocRef);
                    if (!docSnap.exists()) {
                        itemData.createdAt = serverTimestamp();
                    }
                    await setDoc(itemDocRef, itemData, { merge: true });
                    showScanMessage(`Part ${partNumber} saved!`, 'success');
                }
                hideAddItemModal();
            } catch (error) { showScanMessage('Failed to save part.', 'error'); console.error(error) }
        }
        
        function showScanMessage(message, type = 'info') {
            const notificationArea = document.getElementById('notification-area');
            if (!notificationArea) return;

            const notificationEl = document.createElement('div');
            
            let classes = 'p-4 rounded-lg text-center font-medium border shadow-lg transition-opacity duration-300 ease-in-out ';
            switch(type) {
                case 'success': classes += 'bg-green-900/50 text-green-300 border-green-700'; break;
                case 'warning': classes += 'bg-yellow-900/50 text-yellow-300 border-yellow-700'; break;
                case 'error': classes += 'bg-red-900/50 text-red-300 border-red-700'; break;
                default: classes += 'bg-gray-700 text-gray-200 border-gray-600';
            }
            notificationEl.className = classes;
            notificationEl.textContent = message;

            notificationArea.appendChild(notificationEl);

            setTimeout(() => {
                notificationEl.classList.add('opacity-0');
                notificationEl.addEventListener('transitionend', () => {
                    notificationEl.remove();
                });
            }, 5000);
        }

        function showAddItemModal() {
            currentEditingItemId = null;
            addItemForm.reset();
            partNumberInput.disabled = false;
            modalTitle.textContent = "Add New Inventory Part";
            deleteItemBtn.classList.add('hidden');
            addItemModal.classList.remove('hidden');
        }

        function hideAddItemModal() { addItemModal.classList.add('hidden'); }
        
        async function handleEditItem(partId) {
            currentEditingItemId = partId;
            const itemDocRef = doc(inventoryCollectionRef, partId);
            try {
                const docSnap = await getDoc(itemDocRef);
                if (docSnap.exists()) {
                    const item = docSnap.data();
                    partNumberInput.value = partId;
                    partNumberInput.disabled = true;
                    document.getElementById('partDescription').value = item.partDescription || '';
                    document.getElementById('manufacturer').value = item.manufacturer || '';
                    document.getElementById('binLocation').value = item.binLocation || '';
                    document.getElementById('dateCode').value = item.dateCode || '';
                    document.getElementById('cost').value = item.cost || 0;
                    document.getElementById('quantity').value = item.quantity || 0;
                    document.getElementById('minQuantity').value = item.minQuantity || 0;
                    document.getElementById('maxQuantity').value = item.maxQuantity || 0;
                    
                    modalTitle.textContent = "Edit Inventory Part";
                    deleteItemBtn.classList.remove('hidden');
                    addItemModal.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Error fetching item for edit:", error);
            }
        }

        async function handleDeleteItem() {
            if (!currentEditingItemId) return;
            
            confirmAction = async () => {
                try {
                    await deleteDoc(doc(inventoryCollectionRef, currentEditingItemId));
                    showScanMessage(`Part ${currentEditingItemId} deleted.`, 'success');
                    hideAddItemModal();
                } catch (error) {
                    console.error("Error deleting item:", error);
                    showScanMessage('Failed to delete item.', 'error');
                }
                confirmModal.classList.add('hidden');
                confirmAction = null;
            };

            confirmTitle.textContent = "Confirm Part Deletion";
            confirmMessage.textContent = `Are you sure you want to permanently delete part ${currentEditingItemId}? This action cannot be undone.`;
            confirmModal.classList.remove('hidden');
        }

        async function showDetailsModal(partNumber) {
            const itemDocRef = doc(inventoryCollectionRef, partNumber);
            try {
                const docSnap = await getDoc(itemDocRef);
                if (docSnap.exists()) {
                    const item = docSnap.data();
                    detailsPartNumberEl.textContent = `P/N: ${partNumber}`;
                    detailsPartDescriptionEl.textContent = `${item.partDescription}`;
                    detailsBinLocationEl.textContent = `Bin: ${item.binLocation || 'N/A'}`;
                    detailsDateCodeEl.textContent = `Date Code: ${item.dateCode || 'N/A'}`;
                }
            } catch (error) {
                console.error("Error fetching item details:", error);
            }
            
            detailsQrCodeEl.innerHTML = '';
            try {
                const qr = qrcode(4, 'L');
                qr.addData(partNumber);
                qr.make();
                detailsQrCodeEl.innerHTML = qr.createImgTag(6, 4);
            } catch(e) { detailsQrCodeEl.innerHTML = "Error generating QR Code."; }
            detailsModal.classList.remove('hidden');
        }

        function hideDetailsModal() { detailsModal.classList.add('hidden'); }
        
        async function showAdjustStockModal(partNumber) {
            currentAdjustingPartId = partNumber;
            const itemDocRef = doc(inventoryCollectionRef, partNumber);
            try {
                const docSnap = await getDoc(itemDocRef);
                if (docSnap.exists()) {
                    const item = docSnap.data();
                    adjustStockPartInfo.textContent = `${partNumber} - ${item.partDescription}`;
                    adjustStockCurrentQty.textContent = item.quantity;
                    adjustStockModal.classList.remove('hidden');
                } else {
                    showScanMessage(`Part Number ${partNumber} not found.`, 'error');
                }
            } catch (error) {
                console.error("Error fetching item for stock adjustment:", error);
            }
        }

        async function adjustStock(amount) {
            if (!currentAdjustingPartId) return;
            const itemDocRef = doc(inventoryCollectionRef, currentAdjustingPartId);
            try {
                await updateDoc(itemDocRef, {
                    quantity: increment(amount),
                    lastUpdated: serverTimestamp()
                });
                const newQty = parseInt(adjustStockCurrentQty.textContent) + amount;
                adjustStockCurrentQty.textContent = newQty;
                adjustStockAmount.value = '';
            } catch (error) {
                console.error("Error adjusting stock:", error);
            }
        }

        async function setStock(amount) {
            if (!currentAdjustingPartId) return;
            const itemDocRef = doc(inventoryCollectionRef, currentAdjustingPartId);
            try {
                await updateDoc(itemDocRef, {
                    quantity: amount,
                    lastUpdated: serverTimestamp()
                });
                adjustStockCurrentQty.textContent = amount;
                adjustStockAmount.value = '';
            } catch (error) {
                console.error("Error setting stock:", error);
            }
        }
        
        // --- PO Functions ---
        function setupPoListener() {
            onSnapshot(query(poCollectionRef), (snapshot) => {
                poDocs = snapshot.docs;
                renderPurchaseOrders(poDocs);
            });
        }
        
        function showAddPoModal() {
            currentEditingPoId = null;
            addPoForm.reset();
            poModalTitle.textContent = "Create Purchase Order";
            addPoModal.classList.remove('hidden');
        }

        async function handleAddPo(e) {
            e.preventDefault();
            const poData = {
                poNumber: document.getElementById('po-number').value,
                date: document.getElementById('po-date').value,
                vendor: document.getElementById('po-vendor').value,
                partNumber: document.getElementById('po-part-number').value,
                quantity: parseInt(document.getElementById('po-quantity').value, 10),
                cost: parseFloat(document.getElementById('po-cost').value),
                expectedDeliveryDate: document.getElementById('po-delivery-date').value,
                status: 'Open',
                lastUpdated: serverTimestamp()
            };

            const itemDocRef = doc(inventoryCollectionRef, poData.partNumber);
            const itemDoc = await getDoc(itemDocRef);
            if (!itemDoc.exists()) {
                showScanMessage(`Part number ${poData.partNumber} does not exist in inventory. Please add it first.`, 'error');
                return;
            }

            try {
                if (currentEditingPoId) {
                    const poDocRef = doc(poCollectionRef, currentEditingPoId);
                    await updateDoc(poDocRef, poData);
                    showScanMessage(`PO #${poData.poNumber} updated successfully.`, 'success');
                } else {
                    poData.createdAt = serverTimestamp();
                    await addDoc(poCollectionRef, poData);
                    showScanMessage(`PO #${poData.poNumber} created successfully.`, 'success');
                }
                
                addPoForm.reset();
                addPoModal.classList.add('hidden');
            } catch (error) {
                console.error("Error saving PO:", error);
                showScanMessage('Failed to save PO. Check permissions and console.', 'error');
            }
        }

        function renderPurchaseOrders(docs) {
            let docsToRender = docs.filter(doc => doc.data().status === currentPoView);
            poListEl.innerHTML = '';
            if (docsToRender.length === 0) {
                poListEl.innerHTML = `<p class="text-gray-500 text-center py-8">No ${currentPoView.toLowerCase()} purchase orders found.</p>`;
                return;
            }

            const sortedDocs = docsToRender.sort((a, b) => (b.data().createdAt?.seconds || 0) - (a.data().createdAt?.seconds || 0));

            sortedDocs.forEach(doc => {
                const po = doc.data();
                const poEl = document.createElement('div');
                poEl.className = 'p-4 border border-gray-700 rounded-lg';
                
                const isCompleted = po.status === 'Completed';
                
                poEl.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-center">
                        <div><p class="font-semibold text-white">PO #: ${po.poNumber}</p><p class="text-sm text-gray-400">${po.date}</p></div>
                        <div><p class="font-semibold text-white">${po.vendor}</p><p class="text-sm text-gray-400">Vendor</p></div>
                        <div><p class="font-semibold text-white">${po.partNumber}</p><p class="text-sm text-gray-400">Part Number</p></div>
                        <div><p class="font-semibold text-white">${po.quantity} @ $${po.cost.toFixed(2)}</p><p class="text-sm text-gray-400">Order</p></div>
                        <div><p class="font-semibold text-white">${po.expectedDeliveryDate || 'N/A'}</p><p class="text-sm text-gray-400">Expected</p></div>
                        <div class="flex flex-col items-end space-y-2">
                           ${isCompleted 
                                ? `<span class="px-3 py-1 text-sm font-semibold text-green-200 bg-green-800 rounded-full">Completed</span>`
                                : `<span class="px-3 py-1 text-sm font-semibold text-yellow-200 bg-yellow-800 rounded-full">Open</span>`
                           }
                           <div class="flex space-x-2">
                               ${!isCompleted ? `<button data-id="${doc.id}" class="edit-po-btn bg-gray-600 text-white font-bold py-1 px-3 rounded-lg hover:bg-gray-500">Edit</button>` : ''}
                               ${!isCompleted ? `<button data-id="${doc.id}" class="receive-po-btn bg-green-600 text-white font-bold py-1 px-3 rounded-lg hover:bg-green-700">Receive</button>` : ''}
                               ${currentUser.role === 'admin' ? `<button data-id="${doc.id}" class="delete-po-btn bg-red-800 text-white font-bold py-1 px-3 rounded-lg hover:bg-red-700">Delete</button>` : ''}
                           </div>
                        </div>
                    </div>
                `;
                poListEl.appendChild(poEl);
            });

            document.querySelectorAll('.receive-po-btn').forEach(btn => btn.addEventListener('click', handleReceiveOrder));
            document.querySelectorAll('.edit-po-btn').forEach(btn => btn.addEventListener('click', handleEditPo));
            document.querySelectorAll('.delete-po-btn').forEach(btn => btn.addEventListener('click', handleDeletePo));
        }
        
        async function handleEditPo(e) {
            const poId = e.target.dataset.id;
            currentEditingPoId = poId;
            const poDocRef = doc(poCollectionRef, poId);
            try {
                const docSnap = await getDoc(poDocRef);
                if (docSnap.exists()) {
                    const po = docSnap.data();
                    document.getElementById('po-number').value = po.poNumber;
                    document.getElementById('po-date').value = po.date;
                    document.getElementById('po-vendor').value = po.vendor;
                    document.getElementById('po-part-number').value = po.partNumber;
                    document.getElementById('po-quantity').value = po.quantity;
                    document.getElementById('po-cost').value = po.cost;
                    document.getElementById('po-delivery-date').value = po.expectedDeliveryDate;
                    poModalTitle.textContent = "Edit Purchase Order";
                    addPoModal.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Error fetching PO for edit:", error);
            }
        }
        
        async function handleDeletePo(e) {
            const poId = e.target.dataset.id;
            confirmAction = async () => {
                try {
                    await deleteDoc(doc(poCollectionRef, poId));
                    showScanMessage(`Purchase order deleted.`, 'success');
                } catch (error) {
                    console.error("Error deleting PO:", error);
                    showScanMessage('Failed to delete purchase order.', 'error');
                }
                confirmModal.classList.add('hidden');
                confirmAction = null;
            };

            confirmTitle.textContent = "Confirm PO Deletion";
            confirmMessage.textContent = `Are you sure you want to permanently delete this purchase order? This action cannot be undone.`;
            confirmModal.classList.remove('hidden');
        }

        async function handleReceiveOrder(e) {
            const poId = e.target.dataset.id;
            const poDocRef = doc(poCollectionRef, poId);
            
            try {
                const poDoc = await getDoc(poDocRef);
                if (!poDoc.exists()) {
                    throw "PO does not exist!";
                }
                const poData = poDoc.data();

                await runTransaction(db, async (transaction) => {
                    const itemDocRef = doc(inventoryCollectionRef, poData.partNumber);
                    
                    transaction.update(itemDocRef, {
                        quantity: increment(poData.quantity),
                        cost: poData.cost, // Update the cost to the new PO cost
                        lastUpdated: serverTimestamp()
                    });

                    transaction.update(poDocRef, { status: 'Completed' });
                });
                showScanMessage(`PO #${poData.poNumber} received and stock updated.`, 'success');
            } catch (error) {
                console.error("Error receiving PO:", error);
                showScanMessage('Failed to receive PO.', 'error');
            }
        }

    </script>
</body>
</html>
